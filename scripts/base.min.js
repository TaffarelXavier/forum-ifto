/*Desenvolvido por Taffarel Xavier*/
$(document).ready(function(){var f=$("#btnEnviar"),d=$("#labelError"),h=$("#formEnviarMsg"),j=$("#msg"),e=$("#btnFecharImgPreview"),g=false,b=new URL(window.location.href);var i=parseInt(b.searchParams.get("discussao"));f.click(function(){if(j.val().trim().length>0){h.submit()}else{if(g==true){d.html("Digite um título para sua imagem").show().delay(3000).fadeOut()}else{d.html("Digite alguma mensagem").show().delay(3000).fadeOut()}j.focus()}});function c(){var l=screen.availHeight;$("#resultado").animate({scrollTop:parseInt($("#resultado").prop("scrollHeight"))*l},1000)}c();$.get("views/view.get_messages.php",{discussao_id:i},function(l){k(l)});var a=["#99b433","#00a300","#1e7145","#ff0097","#7e3878","#ee1111","#1d1d1d","#00aba9","#2d89ef","#2b5797","#ffc40d","#e3a21a","#da532c"];function k(m){var n=JSON.parse(m),o="",l=0;$.each(n,function(r,u){var t=new Date(u.men_data*1000),s=t.getHours()+":"+t.getMinutes(),p="",q=parseInt(Math.random()*(a.length-0)+0);if(u.men_tipo=="image"){p+="<a><img src='"+u.men_image+"' class='imagens img-responsive'  /></a>"}while(l<a.length){l++}o+='<div class="row-fluid"><div class="mensagens"><p><img src="img/avatar.png" /><b style="color:'+a[q]+' ">&nbsp;<i>'+u.nome+"</i></b></p><p><pre>"+u.men_mensagens+"</pre></p>"+p+'<label class="text-info data-msg" title="'+t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear()+'">'+s+"</label></div></div>"});$("#resultado").html(o)}document.getElementById("msg").onpaste=function(p){var n=(p.clipboardData||p.originalEvent.clipboardData).items;var m=null;for(var o=0;o<n.length;o++){if(n[o].type.indexOf("image")===0){m=n[o].getAsFile()}}if(m!==null){var l=new FileReader();l.onload=function(q){console.log(q.target.result);$("#pastedImage").show();e.show();$("#edit_imagem").val(q.target.result);$("#msg_tipo").val("image");g=true;j.attr("placeholder","Digite um título para sua imagem");document.getElementById("pastedImage").src=q.target.result};l.readAsDataURL(m)}};e.click(function(){$(this).hide();$("#pastedImage").hide();$("#msg_tipo").val("text");j.attr("placeholder","Digite sua mensagem");g=false});$(this).LongPolling({nomeDaVariavelLocalStorage:"dados",url:"views/view.get_messages.php",tempoCarregamento:1000,metodo:"POST",dataHttp:{discussao_id:i},objetoParaPreencher:"",receberDados:function(l){k(l)}});j.keyup(function(l){var m=$(this);if(l.keyCode==13&&!l.shiftKey){if(m.val().trim().length>0){h.submit()}else{if(g==true){d.html("Digite um título para sua imagem").show().delay(3000).fadeOut()}else{d.html("Digite alguma mensagem").show().delay(3000).fadeOut()}j.focus()}}});h.ajaxForm({url:"modelos/model.mensagens.php",beforeSend:function(){f.html("Enviando, aguarde, por favor.").attr("disabled",true)},uploadProgress:function(o,l,n,m){},success:function(l){if(l=="1"){f.html("Enviar").attr("disabled",false);j.val("").focus();c();$("#pastedImage").hide();e.hide();$("#msg_tipo").val("text")}else{if(l=="2"){alert("Não foi possível fazer a alteração.")}else{alert("Houve um erro. Tente novamente.\nCódigo do erro:"+l)}}},complete:function(l){}});$("#btnSair").click(function(){$.get("funcoes/funcao.sair.php",function(){window.location.href="login"})})});