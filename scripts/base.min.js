/*Desenvolvido por Taffarel Xavier*/
$(document).ready(function(){var f=$("#btnEnviar"),d=$("#labelError"),i=$("#formEnviarMsg"),k=$("#msg"),e=$("#btnFecharImgPreview"),g=false,b=new URL(window.location.href);var j=parseInt(b.searchParams.get("discussao"));f.click(function(){if(k.val().trim().length>0){i.submit()}else{if(g==true){d.html("Digite um título para sua imagem").show().delay(3000).fadeOut()}else{d.html("Digite alguma mensagem").show().delay(3000).fadeOut()}k.focus()}});function c(){var m=screen.availHeight;$("#resultado").animate({scrollTop:parseInt($("#resultado").prop("scrollHeight"))*m},1000)}c();$.get("../views/view.get_messages.php",{discussao_id:j},function(m){l(m)});var a=["#99b433","#00a300","#1e7145","#ff0097","#7e3878","#ee1111","#2B70AD","#1d1d1d","#00aba9","#2d89ef","#2b5797","#ffc40d","#e3a21a","#da532c"];$("#resultado").scroll(function(n){var m=$(this).scrollTop();if(m>=150){$("#goParaTopo").slideDown()}else{$("#goParaTopo").slideUp()}});function h(o){$(o).css({display:"block",width:200+"px",height:200+"px"});var n=$(o).attr("src");var m=window.open("_top");m.document.write("<img src='"+n+"' />");m.document.title="Visualização de Imagem"}function l(n){var q=JSON.parse(n),r="",m=0,p=new Date(),o=p.getHours()+":"+p.getMinutes(),s="Esta é uma mensagem fixa";r+='<div class="row-fluid"><div class="mensagens"><p><b style="color:'+a[6]+' ">Usuário padrão.</b></p><p><pre>'+s+'</pre></p><label class="text-info data-msg" title="'+p.getDate()+"-"+(p.getMonth()+1)+"-"+p.getFullYear()+'">'+o+'</label><hr class="msg-hr"/></div></div>';$.each(q,function(t,u){p=new Date(u.men_data*1000),o=p.getHours()+":"+p.getMinutes(),img="",_rand=parseInt(Math.random()*(a.length-0)+0);if(u.men_tipo=="image"){img+="<a><img src='"+u.men_image+"' class='msg-imagens img-responsive'  /></a>"}while(m<a.length){m++}r+='<div class="row-fluid"><div class="mensagens"><p><b style="color:'+a[_rand]+' ">&nbsp;<i>'+u.nome+"</i></b></p><p><pre>"+u.men_mensagens+"</pre></p>"+img+'<label class="text-info data-msg" title="'+p.getDate()+"-"+(p.getMonth()+1)+"-"+p.getFullYear()+'">'+o+'</label><hr class="msg-hr"/></div></div>'});$("#resultado").html(r);$(".msg-imagens").click(function(){var t=$(this);h(t)})}$("#goParaTopo").click(function(){var m=$(this);m.slideUp();$("#resultado").animate({scrollTop:parseInt(0)},500)});document.getElementById("msg").onpaste=function(q){var o=(q.clipboardData||q.originalEvent.clipboardData).items;var n=null;for(var p=0;p<o.length;p++){if(o[p].type.indexOf("image")===0){n=o[p].getAsFile()}}if(n!==null){var m=new FileReader();m.onload=function(r){console.log(r.target.result);$("#pastedImage").show();e.show();$("#edit_imagem").val(r.target.result);$("#msg_tipo").val("image");g=true;k.attr("placeholder","Digite um título para sua imagem");document.getElementById("pastedImage").src=r.target.result};m.readAsDataURL(n)}};e.click(function(){$(this).hide();$("#pastedImage").hide();$("#msg_tipo").val("text");k.attr("placeholder","Digite sua mensagem");g=false});$(this).LongPolling({nomeDaVariavelLocalStorage:"dados",url:"../views/view.get_messages.php",tempoCarregamento:1000,metodo:"POST",dataHttp:{discussao_id:j},objetoParaPreencher:"",receberDados:function(m){l(m)}});k.keyup(function(m){var n=$(this);if(m.keyCode==13&&!m.shiftKey){if(n.val().trim().length>0){i.submit()}else{if(g==true){d.html("Digite um título para sua imagem").show().delay(3000).fadeOut()}else{d.html("Digite alguma mensagem").show().delay(3000).fadeOut()}k.focus()}}});i.ajaxForm({url:"../modelos/model.mensagens.php",beforeSend:function(){f.html("Enviando, aguarde, por favor.").attr("disabled",true)},uploadProgress:function(p,m,o,n){},success:function(m){if(m=="1"){f.html("<i class='fa fa-paper-plane fa-2x' aria-hidden='true'></i>").attr("disabled",false);k.val("").focus();c();$("#pastedImage").hide();e.hide();$("#msg_tipo").val("text")}else{if(m=="2"){alert("Não foi possível fazer a alteração.")}else{alert("Houve um erro. Tente novamente.\nCódigo do erro:"+m)}}},complete:function(m){}});$("#btnSair").click(function(){$.get("funcoes/funcao.sair.php",function(){window.location.href="login"})})});